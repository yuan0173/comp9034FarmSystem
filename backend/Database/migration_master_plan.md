# ğŸš€ æ•°æ®åº“è¿ç§»å®æ–½æ€»è®¡åˆ’

## ğŸ“… æ—¶é—´è¡¨ä¸é‡Œç¨‹ç¢‘

### Week 1: Phase 1 - åŸºç¡€ä¼˜åŒ–

- **ç›®æ ‡**: ä¼˜åŒ–ç°æœ‰è¡¨ç»“æ„ï¼Œé›¶é£é™©å­—æ®µæ‰©å±•
- **æ‰§è¡Œ**: è¿è¡Œ `migration_phase1.sql`
- **éªŒè¯**: æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ï¼ŒAPI å…¼å®¹æ€§æµ‹è¯•
- **å›æ»š**: å¦‚æœ‰é—®é¢˜ï¼Œå¯å®‰å…¨å›æ»š

### Week 2-3: Phase 2 - ä¸šåŠ¡æ‰©å±•

- **ç›®æ ‡**: æ·»åŠ æ’ç­å’Œè–ªèµ„ç³»ç»Ÿ
- **æ‰§è¡Œ**: è¿è¡Œ `migration_phase2.sql`
- **éªŒè¯**: æ–°åŠŸèƒ½å•å…ƒæµ‹è¯•ï¼Œä¸šåŠ¡é€»è¾‘éªŒè¯
- **é£é™©**: ä¸­ç­‰ï¼Œæ–°è¡¨åˆ›å»ºä¸å½±å“ç°æœ‰åŠŸèƒ½

### Week 4: Phase 3 - é«˜çº§ç‰¹æ€§

- **ç›®æ ‡**: ç”Ÿç‰©è¯†åˆ«éªŒè¯ç³»ç»Ÿ
- **æ‰§è¡Œ**: è¿è¡Œ `migration_phase3.sql`
- **éªŒè¯**: å®‰å…¨åŠŸèƒ½æµ‹è¯•ï¼Œæ€§èƒ½å‹åŠ›æµ‹è¯•
- **é£é™©**: è¾ƒé«˜ï¼Œå¤æ‚ä¸šåŠ¡é€»è¾‘éœ€å……åˆ†æµ‹è¯•

## ğŸ›¡ï¸ é£é™©ç®¡ç†ç­–ç•¥

### é«˜é£é™©é¡¹ç›®

1. **æ•°æ®ä¸¢å¤±é£é™©**

   - **ç¼“è§£**: æ¯é˜¶æ®µå‰å®Œæ•´å¤‡ä»½
   - **ç›‘æ§**: å®æ—¶æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
   - **åº”æ€¥**: å‡†å¤‡å¿«é€Ÿå›æ»šè„šæœ¬

2. **æ€§èƒ½ä¸‹é™é£é™©**

   - **ç¼“è§£**: åˆ†æ‰¹æ‰§è¡Œï¼Œç›‘æ§æŸ¥è¯¢æ€§èƒ½
   - **ç›‘æ§**: è®¾ç½®æ€§èƒ½å‘Šè­¦é˜ˆå€¼
   - **åº”æ€¥**: ç´¢å¼•ä¼˜åŒ–å’ŒæŸ¥è¯¢è°ƒä¼˜

3. **ä¸šåŠ¡ä¸­æ–­é£é™©**
   - **ç¼“è§£**: é€‰æ‹©ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œ
   - **ç›‘æ§**: åº”ç”¨å¥åº·æ£€æŸ¥
   - **åº”æ€¥**: å¿«é€Ÿå›æ»šå’ŒæœåŠ¡é‡å¯

### ä¸­ç­‰é£é™©é¡¹ç›®

1. **API å…¼å®¹æ€§é—®é¢˜**

   - **ç¼“è§£**: å‘åå…¼å®¹è§†å›¾å’Œå­—æ®µä¿ç•™
   - **ç›‘æ§**: API å“åº”æ ¼å¼éªŒè¯
   - **åº”æ€¥**: å…¼å®¹æ€§è¡¥ä¸å¿«é€Ÿéƒ¨ç½²

2. **æ–°åŠŸèƒ½ç¼ºé™·**
   - **ç¼“è§£**: å……åˆ†çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
   - **ç›‘æ§**: é”™è¯¯æ—¥å¿—å®æ—¶ç›‘æ§
   - **åº”æ€¥**: åŠŸèƒ½å¼€å…³æ§åˆ¶

## ğŸ“Š è¯¦ç»†æ‰§è¡Œæ­¥éª¤

### Phase 1 æ‰§è¡Œæ¸…å•

```bash
# 1. ç¯å¢ƒå‡†å¤‡
â–¡ æ•°æ®åº“å®Œæ•´å¤‡ä»½
â–¡ åº”ç”¨æœåŠ¡æš‚åœ (å¯é€‰ï¼Œå»ºè®®å‡Œæ™¨æ‰§è¡Œ)
â–¡ æ‰§è¡Œç”¨æˆ·æƒé™ç¡®è®¤

# 2. è„šæœ¬æ‰§è¡Œ
â–¡ è¿è¡Œ migration_phase1.sql
â–¡ éªŒè¯æ‰§è¡Œç»“æœ
â–¡ æ£€æŸ¥é”™è¯¯æ—¥å¿—

# 3. æ•°æ®éªŒè¯
â–¡ å­—æ®µå®Œæ•´æ€§æ£€æŸ¥
â–¡ ç´¢å¼•æ€§èƒ½æµ‹è¯•
â–¡ å…¼å®¹æ€§è§†å›¾éªŒè¯

# 4. åº”ç”¨æ›´æ–°
â–¡ æ›´æ–° Entity Framework æ¨¡å‹
â–¡ API å“åº”æ ¼å¼éªŒè¯
â–¡ å‰ç«¯å…¼å®¹æ€§æµ‹è¯•

# 5. å®Œæˆç¡®è®¤
â–¡ åŠŸèƒ½å›å½’æµ‹è¯•
â–¡ æ€§èƒ½åŸºçº¿å¯¹æ¯”
â–¡ æ¢å¤æ­£å¸¸æœåŠ¡
```

### å›æ»šç¨‹åº

```sql
-- ç´§æ€¥å›æ»šè„šæœ¬æ¨¡æ¿
-- è­¦å‘Š: ä»…åœ¨å‡ºç°ä¸¥é‡é—®é¢˜æ—¶ä½¿ç”¨

-- 1. ç«‹å³åœæ­¢åº”ç”¨æœåŠ¡
-- 2. æ¢å¤æ•°æ®åº“å¤‡ä»½
RESTORE DATABASE [FarmTimeMS] FROM DISK = 'backup_before_migration.bak'
WITH REPLACE, STATS = 10;

-- 3. é‡å¯åº”ç”¨æœåŠ¡
-- 4. éªŒè¯åŠŸèƒ½æ­£å¸¸

-- æˆ–è€…ä½¿ç”¨æ¸è¿›å›æ»š (å¦‚æœæ•°æ®æœªæŸå)
-- è¯¦è§å„ Phase è„šæœ¬ä¸­çš„å›æ»šæ³¨é‡Šéƒ¨åˆ†
```

## ğŸ§ª æµ‹è¯•éªŒè¯æ–¹æ¡ˆ

### è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

```sql
-- æ•°æ®å®Œæ•´æ€§éªŒè¯
CREATE PROCEDURE sp_ValidateDataIntegrity
AS
BEGIN
    -- 1. è®°å½•æ•°ç»Ÿè®¡
    SELECT 'Staffs' AS TableName, COUNT(*) AS RecordCount FROM Staffs;
    SELECT 'Events' AS TableName, COUNT(*) AS RecordCount FROM Events;
    SELECT 'Devices' AS TableName, COUNT(*) AS RecordCount FROM Devices;

    -- 2. å¤–é”®å®Œæ•´æ€§
    SELECT 'Orphaned Events' AS Issue, COUNT(*) AS Count
    FROM Events e LEFT JOIN Staffs s ON e.StaffId = s.Id
    WHERE s.Id IS NULL;

    -- 3. æ•°æ®ç±»å‹éªŒè¯
    SELECT 'Invalid HourlyRate' AS Issue, COUNT(*) AS Count
    FROM Staffs WHERE HourlyRate < 0 OR HourlyRate > 1000;

    -- 4. æ–°å­—æ®µå¡«å……æ£€æŸ¥
    SELECT 'Missing FirstName' AS Issue, COUNT(*) AS Count
    FROM Staffs WHERE FirstName IS NULL AND IsActive = 1;
END;
```

### æ€§èƒ½åŸºçº¿æµ‹è¯•

```sql
-- æ ¸å¿ƒæŸ¥è¯¢æ€§èƒ½æµ‹è¯•
SET STATISTICS IO ON;
SET STATISTICS TIME ON;

-- æµ‹è¯•1: å‘˜å·¥è€ƒå‹¤æŸ¥è¯¢
SELECT s.FirstName, s.LastName, COUNT(e.Id) AS EventCount
FROM Staffs s
LEFT JOIN Events e ON s.Id = e.StaffId
WHERE s.IsActive = 1
GROUP BY s.Id, s.FirstName, s.LastName;

-- æµ‹è¯•2: æ’ç­æŸ¥è¯¢ (Phase 2 å)
SELECT s.FirstName, s.LastName, ws.Date, ws.StartTime, ws.EndTime
FROM WorkSchedules ws
INNER JOIN Staffs s ON ws.StaffId = s.Id
WHERE ws.Date BETWEEN GETDATE() AND DATEADD(DAY, 7, GETDATE());

-- æµ‹è¯•3: ç”Ÿç‰©è¯†åˆ«éªŒè¯æŸ¥è¯¢ (Phase 3 å)
SELECT bv.VerificationResult, COUNT(*) AS Count
FROM BiometricVerifications bv
WHERE bv.CreatedAt >= DATEADD(DAY, -1, GETUTCDATE())
GROUP BY bv.VerificationResult;

SET STATISTICS IO OFF;
SET STATISTICS TIME OFF;
```

## ğŸ“ˆ æˆåŠŸæŒ‡æ ‡

### Phase 1 æˆåŠŸæ ‡å‡†

- âœ… é›¶æ•°æ®ä¸¢å¤±
- âœ… API å“åº”æ—¶é—´å¢åŠ  < 10%
- âœ… æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… æ–°å­—æ®µæ­£ç¡®å¡«å…… > 95%

### Phase 2 æˆåŠŸæ ‡å‡†

- âœ… æ’ç­åŠŸèƒ½å¯ç”¨æ€§ > 99%
- âœ… è–ªèµ„è®¡ç®—å‡†ç¡®ç‡ 100%
- âœ… æ–°è¡¨æŸ¥è¯¢æ€§èƒ½ < 100ms
- âœ… å­˜å‚¨è¿‡ç¨‹æ‰§è¡ŒæˆåŠŸç‡ > 99%

### Phase 3 æˆåŠŸæ ‡å‡†

- âœ… ç”Ÿç‰©è¯†åˆ«åŒ¹é…å‡†ç¡®ç‡ > 95%
- âœ… éªŒè¯å“åº”æ—¶é—´ < 2 ç§’
- âœ… å®‰å…¨å®¡è®¡æ—¥å¿—å®Œæ•´æ€§ 100%
- âœ… å¯ç–‘æ´»åŠ¨æ£€æµ‹æœ‰æ•ˆæ€§éªŒè¯

## ğŸ”§ Entity Framework æ¨¡å‹æ›´æ–°

### Phase 1 åçš„æ¨¡å‹æ›´æ–°

```csharp
// æ›´æ–° Staff.cs æ¨¡å‹
public class Staff
{
    // ç°æœ‰å­—æ®µä¿ç•™...

    // æ–°å¢å­—æ®µ
    public string? FirstName { get; set; }
    public string? LastName { get; set; }
    public string? ContractType { get; set; }
    public int? StandardHoursPerWeek { get; set; }
    public decimal? OvertimePayRate { get; set; }

    // è®¡ç®—å±æ€§
    public string FullName => $"{FirstName} {LastName}".Trim();
}

// æ›´æ–° ApplicationDbContext.cs
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    // ç°æœ‰é…ç½®ä¿ç•™...

    // æ–°å¢å­—æ®µé…ç½®
    modelBuilder.Entity<Staff>(entity =>
    {
        entity.Property(e => e.FirstName).HasMaxLength(50);
        entity.Property(e => e.LastName).HasMaxLength(50);
        entity.Property(e => e.ContractType).HasMaxLength(20);
    });
}
```

### Phase 2 åçš„æ–°æ¨¡å‹

```csharp
// æ–°å¢ WorkSchedule.cs
public class WorkSchedule
{
    public int Id { get; set; }
    public int StaffId { get; set; }
    public DateTime Date { get; set; }
    public TimeSpan StartTime { get; set; }
    public TimeSpan EndTime { get; set; }
    public decimal ScheduleHours { get; set; }
    public string Status { get; set; } = "scheduled";
    public string? Notes { get; set; }
    public int? CreatedBy { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }

    // Navigation properties
    public virtual Staff Staff { get; set; } = null!;
    public virtual Staff? Creator { get; set; }
}

// æ–°å¢ Salary.cs
public class Salary
{
    public int Id { get; set; }
    public int StaffId { get; set; }
    public DateTime PayPeriodStart { get; set; }
    public DateTime PayPeriodEnd { get; set; }
    public decimal TotalHours { get; set; }
    public decimal TotalOvertimeHours { get; set; }
    public decimal? ScheduledHours { get; set; }
    public decimal RegularPay { get; set; }
    public decimal OvertimePay { get; set; }
    public decimal GrossPay { get; set; }
    public decimal Deductions { get; set; }
    public decimal NetPay { get; set; }
    public string Status { get; set; } = "draft";
    public int? CalculatedBy { get; set; }
    public int? ApprovedBy { get; set; }
    public DateTime GeneratedAt { get; set; }
    public DateTime? ApprovedAt { get; set; }

    // Navigation properties
    public virtual Staff Staff { get; set; } = null!;
    public virtual Staff? Calculator { get; set; }
    public virtual Staff? Approver { get; set; }
}
```

### Phase 3 åçš„é«˜çº§æ¨¡å‹

```csharp
// æ–°å¢ BiometricVerification.cs
public class BiometricVerification
{
    public int Id { get; set; }
    public int? StaffId { get; set; }
    public int? BiometricId { get; set; }
    public int DeviceId { get; set; }
    public int? EventId { get; set; }
    public string VerificationResult { get; set; } = string.Empty;
    public decimal? ConfidenceScore { get; set; }
    public string? FailureReason { get; set; }
    public string? CapturedTemplate { get; set; }
    public int? ProcessingTime { get; set; }
    public string? IpAddress { get; set; }
    public string? UserAgent { get; set; }
    public DateTime CreatedAt { get; set; }

    // Navigation properties
    public virtual Staff? Staff { get; set; }
    public virtual BiometricData? BiometricData { get; set; }
    public virtual Device Device { get; set; } = null!;
    public virtual Event? Event { get; set; }
}
```

## ğŸ¯ åç»­ç»´æŠ¤å»ºè®®

### æ—¥å¸¸ç›‘æ§

1. **æ€§èƒ½ç›‘æ§**: è®¾ç½®æŸ¥è¯¢æ€§èƒ½å‘Šè­¦
2. **æ•°æ®å¢é•¿**: ç›‘æ§è¡¨å¤§å°å¢é•¿è¶‹åŠ¿
3. **ç´¢å¼•ä¼˜åŒ–**: å®šæœŸåˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
4. **æ¸…ç†ç­–ç•¥**: åˆ¶å®šå†å²æ•°æ®æ¸…ç†è®¡åˆ’

### æ‰©å±•è®¡åˆ’

1. **å¤šç§Ÿæˆ·æ”¯æŒ**: æ·»åŠ  TenantId å­—æ®µ
2. **æ—¶åŒºå¤„ç†**: å‡çº§æ—¶é—´å­—æ®µä¸ºæ—¶åŒºæ„ŸçŸ¥
3. **å›½é™…åŒ–**: æ·»åŠ å¤šè¯­è¨€æ”¯æŒå­—æ®µ
4. **ç§»åŠ¨ç«¯ API**: ä¼˜åŒ–ç§»åŠ¨è®¾å¤‡è®¿é—®

---

**æ€»ç»“**: è¿™ä¸ªè¿ç§»è®¡åˆ’æä¾›äº†ä»ç°æœ‰è®¾è®¡åˆ° Tan è®¾è®¡çš„å®Œæ•´è½¬æ¢è·¯å¾„ï¼Œç¡®ä¿äº†é›¶åœæœºæ—¶é—´å’Œæ•°æ®å®‰å…¨ã€‚é€šè¿‡åˆ†é˜¶æ®µå®æ–½å’Œå……åˆ†çš„æµ‹è¯•éªŒè¯ï¼Œå¯ä»¥å®‰å…¨åœ°å®ç°æ•°æ®åº“æ¶æ„çš„ç°ä»£åŒ–å‡çº§ã€‚

è®°ä½ï¼š**æ¸è¿›å¼è¿ç§» + å……åˆ†æµ‹è¯• + å¿«é€Ÿå›æ»š = æˆåŠŸçš„æ•°æ®åº“æ¼”è¿›** ğŸš€
